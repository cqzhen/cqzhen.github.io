[返回导航页](https://cqzhen.github.io/blog.html "导航页面")

# 浏览器工作流程

用户都期待自己浏览的网站加载速度快和交互顺畅。那当我们在浏览器输入 URL 敲回车键后，浏览器是怎么工作呢？
>1. 导航
触发导航的可以是浏览器的一个 Url 请求或是提交一个表单或是点击一个链接。>>1. DNS Lookup（DNS 查询）
>>>1. 当你访问一个 Url 时候，浏览器会检查缓存中是否这个域名对应的解析过的 IP 地址，如果缓存里面有，这个解析就结束。
>>>2. 如果浏览器缓存也没有，浏览器就会查找操作系统缓存（注：本地域名劫持）。
>>>3. LDNS （本地区域名服务器：电信、联通、移动，缓存有效时间和域名的有效时间有关，大约 80% 的域名解析在这步就结束了）
>>>4. Root server (根域名服务器），根域名服务器返回给本地域名服务器一个所查询域的主域服务器（gTLD Server）地址。（gTLD 是国际顶级域名服务器，如：.com、.cn、.org 等）
>>>5. 本地域名服务器再向上一步返回的 gTLD 服务器发送请求。
>>>6. gTLD 服务器查找返回此域名对应的 Name Server 域名服务器的地址（域名提供商的服务器）
>>>7. Name Server 域名服务器查询存储的域名和 IP 的映射关系表。然后将 IP 和 TTL 值返回给 DNS Server 域名服务器
>>>8. DNS Server 缓存域名和 IP 的对应关系，缓存时间由 TTL 值控制
>>>9. 返回给用户，用户根据 TTL 值缓存在本地系统缓存中，解析过程结束。![DNS](https://mdn.mozillademos.org/files/16743/latency.jpg)
>>2. TCP Handshake (TCP 三次握手)
为什么不是两次或四次，而是三次？
>>3. TLS Negotiation (三次）
为什么不是两次或四次，而是三次？
>2. Response 
每个请求对应一个答复
>>1. TCP Slow Start/14kb rule
14 kb -> 28 kb -> 56kb -> (n-1) *2 -> ... 直到递增到限制门槛大小为止
TCP 慢启动初始响应为 14 kb，逐渐建立适合网络功能的传输速度，避免拥塞。
>>2. Congestion control
当服务器以TCP数据包的形式发送数据时，用户的客户端通过返回确认或ACK确认传递。 连接的能力有限，具体取决于硬件和网络状况。 如果服务器发送太多的数据包太快，它们将被丢弃。 意思是，不会有任何确认。 服务器将其注册为丢失的ACK。 拥塞控制算法使用发送的数据包和ACK的这种流来确定发送速率。
>3. Parsing (解析）
一旦浏览器接收到第一批数据，它就可以开始解析收到的信息。 解析是浏览器将其从网络上接收的数据转换为DOM和CSSOM的步骤，渲染器使用它来将页面绘制到屏幕上。
>>1. Building the DOM tree（第一步）
第一步是处理HTML标记并构建DOM树。 HTML解析涉及令牌化和树结构。 HTML令牌包括开始和结束标签，以及属性名称和值。 如果文档格式正确，则解析起来将更加直接，快捷。 解析器将标记化的输入解析到文档中，从而建立文档树。
DOM树描述了文档的内容。 <html>元素是文档树的第一个标签和根节点。 该树反映了不同标签之间的关系和层次结构。 嵌套在其他标签中的标签是子节点。 DOM节点数量越多，构造DOM树所需的时间就越长。
当解析器找到非阻塞资源（例如图像）时，浏览器将请求这些资源并继续解析。 当遇到CSS文件时，解析可以继续，但是<script>标记（尤其是那些没有async或defer属性的标记）会阻止呈现，并暂停HTML的解析。 尽管浏览器的预加载扫描程序加快了此过程，但是过多的脚本仍然可能是一个严重的瓶颈。
>>2. Preload scanner
浏览器构建DOM树时，此过程占用主线程。 发生这种情况时，预加载扫描程序将解析可用的内容，并请求高优先级的资源，例如CSS，JavaScript和Web字体。 多亏了预加载扫描程序，我们不必等到解析器找到对外部资源的引用来请求它。 它将在后台检索资源，以便在主HTML解析器到达请求的资产时，它们可能已经在飞行中或已被下载。 预加载扫描仪提供的优化功能可减少堵塞。
当主线程解析HTML和CSS时，预加载扫描程序将找到脚本和图像，并也开始下载它们。 为确保脚本不会阻塞进程，请添加async属性或defer属性，如果JavaScript的解析和执行顺序不重要。
>>3. Building the CSSOM（第二步）
处理CSS并构建CSSOM树。 CSS对象模型类似于DOM。 DOM和CSSOM都是树。 它们是独立的数据结构。 浏览器将CSS规则转换为可以理解和使用的样式图。 浏览器浏览CSS中的每个规则集，基于CSS选择器创建具有父级，子级和同级关系的节点树。
与HTML一样，浏览器需要将收到的CSS规则转换为可以使用的规则。 因此，它重复了HTML到对象的过程。
>>4. JavaScript Compilation
>>5. Building the Accessibility Tree
>4. Render
>>1. Style（第三步)
>>2. Layout（第四步）
关注点重排
>>3. Paint（第五步/最后一步）
关注点重绘
>>4. Compositiong
>5. Interactivity
